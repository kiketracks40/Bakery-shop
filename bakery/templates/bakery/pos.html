{% extends 'bakery/base.html' %}

{% block title %}Point of Sale - Bakery POS{% endblock %}

{% block content %}
<h2>Point of Sale</h2>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                Products
            </div>
            <div class="card-body">
                <div class="row">
                    {% for product in products %}
                    <div class="col-md-4 mb-3">
                        <div class="card product-card" data-id="{{ product.id }}" data-name="{{ product.name }}" data-price="{{ product.price }}">
                            <div class="card-body text-center">
                                <h5 class="card-title">{{ product.name }}</h5>
                                <p class="card-text">${{ product.price }}</p>
                                <button class="btn btn-sm btn-primary add-to-cart">Add</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                Current Order
            </div>
            <div class="card-body">
                <div id="cart-items">
                    <!-- Cart items will be displayed here -->
                    <p class="text-center text-muted">No items added yet</p>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Total:</span>
                    <span id="cart-total">$0.00</span>
                </div>
                <div class="mt-3">
                    <select class="form-select mb-3" id="payment-method">
                        <option value="CASH">Cash</option>
                        <option value="CARD">Card</option>
                    </select>
                    <button id="checkout-btn" class="btn btn-success w-100">Checkout</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cart = [];
        updateCart();
        
        // Add product to cart
        document.querySelectorAll('.add-to-cart').forEach(button => {
            button.addEventListener('click', function() {
                const card = this.closest('.product-card');
                const productId = card.dataset.id;
                const productName = card.dataset.name;
                const productPrice = parseFloat(card.dataset.price);
                
                // Check if product is already in cart
                const existingItem = cart.find(item => item.productId === productId);
                if (existingItem) {
                    existingItem.quantity += 1;
                } else {
                    cart.push({
                        productId: productId,
                        name: productName,
                        price: productPrice,
                        quantity: 1
                    });
                }
                
                updateCart();
            });
        });
        
        // Update cart display
        function updateCart() {
            const cartElement = document.getElementById('cart-items');
            const totalElement = document.getElementById('cart-total');
            
            if (cart.length === 0) {
                cartElement.innerHTML = '<p class="text-center text-muted">No items added yet</p>';
                totalElement.textContent = '$0.00';
                return;
            }
            
            let total = 0;
            let cartHTML = '<ul class="list-group list-group-flush">';
            
            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                
                cartHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span>${item.name}</span>
                        <br>
                        <small class="text-muted">$${item.price.toFixed(2)} x ${item.quantity}</small>
                    </div>
                    <span>$${itemTotal.toFixed(2)}</span>
                </li>`;
            });
            
            cartHTML += '</ul>';
            cartElement.innerHTML = cartHTML;
            totalElement.textContent = '$' + total.toFixed(2);
        }
        
        // Checkout button
        document.getElementById('checkout-btn').addEventListener('click', function() {
            if (cart.length === 0) {
                alert('Please add items to the cart first.');
                return;
            }
            
            // Create a form to submit the sale data
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/create-sale/';  // New view we'll create
            
            // Add CSRF token
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrfmiddlewaretoken';
            csrfToken.value = getCookie('csrftoken');
            form.appendChild(csrfToken);
            
            // Add payment method
            const paymentMethod = document.createElement('input');
            paymentMethod.type = 'hidden';
            paymentMethod.name = 'payment_method';
            paymentMethod.value = document.getElementById('payment-method').value;
            form.appendChild(paymentMethod);
            
            // Add cart items as JSON
            const itemsInput = document.createElement('input');
            itemsInput.type = 'hidden';
            itemsInput.name = 'items_json';
            itemsInput.value = JSON.stringify(cart);
            form.appendChild(itemsInput);
            
            // Submit the form
            document.body.appendChild(form);
            form.submit();
        });
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %}